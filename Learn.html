<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Financial Learning App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        /* Custom styling for the BudgetBuddy logo */
        .budgetbuddy-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 900;
            color: #1f2937;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .budgetbuddy-logo .logo-icon {
            color: #4f46e5;
            transition: transform 0.3s ease;
        }
        .budgetbuddy-logo:hover {
            color: #6366f1;
            transform: scale(1.02);
            text-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
        }
        .budgetbuddy-logo:hover .logo-icon {
            transform: rotate(-10deg) scale(1.1);
        }

        .btn {
            background-color: #4f46e5;
            color: #ffffff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .option-btn {
            background-color: #e5e7eb;
            color: #1f2937;
            font-weight: 500;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: left;
            transition: background-color 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .option-btn:hover {
            background-color: #d1d5db;
        }
        .option-btn.correct {
            background-color: #10b981;
            color: white;
        }
        .option-btn.incorrect {
            background-color: #ef4444;
            color: white;
        }
        .badge {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: #fcd34d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .badge:hover {
            transform: scale(1.1);
        }
        .badge-text {
            font-size: 24px;
        }
        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            animation: fadeIn 0.3s ease-out;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4f46e5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .back-button-container {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 10;
        }
        .back-button-effect {
            display: flex;
            align-items: center;
            color: #6b7280;
            font-weight: 500;
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(209, 213, 219, 0.4);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
        }
        .back-button-effect:hover {
            color: #4f46e5;
            transform: translateX(-8px) rotate(-5deg) scale(1.05);
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4), 0 0 15px rgba(79, 70, 229, 0.8);
            border-color: #6366f1;
        }
        .back-button-effect:active {
            transform: translateY(0) scale(0.95) rotate(0deg);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            background: #c7d2fe;
            transition-duration: 0.1s;
        }
        .back-button-effect .back-icon {
            font-size: 1.3rem;
            margin-right: 0.6rem;
            transition: transform 0.3s ease;
        }
        .back-button-effect:hover .back-icon {
            transform: translateX(-2px);
        }

    </style>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-11460123013">
</script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-11460123013');
</script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container rounded-2xl shadow-xl p-8 flex flex-col gap-6">
        <div class="auth-master-container">
            <div class="back-button-container">
                <button onclick="goToPreviousPage()" class="back-button-effect">
                    <i class="fas fa-arrow-left back-icon"></i>
                    <span class="font-medium">FUN CLICK</span>
                </button>
            </div>
        </div>

        <!-- Header Section -->
        <div class="header flex justify-between items-center flex-wrap gap-4">
            <!-- BudgetBuddy Logo -->
            <a href="main.html" onclick="saveQuizState()" class="budgetbuddy-logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-banknote w-8 h-8 logo-icon">
                    <rect width="20" height="12" x="2" y="6" rx="2"></rect>
                    <circle cx="12" cy="12" r="2"></circle>
                    <path d="M6 12h.01M18 12h.01"></path>
                </svg>
                <span>BudgetBuddy</span>
            </a>
            <div class="flex items-center gap-4">
                <span id="level-display" class="text-xl font-semibold text-gray-600">Level 1</span>
                <span id="score-display" class="text-xl font-semibold text-gray-600">Score: 0</span>
            </div>
        </div>

        <div class="flex justify-between items-center text-sm text-gray-500">
            <span class="text-gray-600 font-medium">Progress is automatically saved.</span>
            <span id="user-id-display">User ID: N/A</span>
        </div>
        
        <hr class="border-t border-gray-200">
        
        <!-- Main Quiz Section -->
        <div id="quiz-section" class="flex flex-col gap-6">
            <div class="p-6 bg-purple-50 rounded-xl">
                <h2 id="question-text" class="text-xl font-bold text-gray-800"></h2>
            </div>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Options will be dynamically inserted here -->
            </div>
        </div>

        <!-- Progress Chart and Badges Section -->
        <div id="results-section" class="flex flex-col gap-4 mt-6" style="display: none;">
            <h2 class="text-2xl font-bold text-center text-gray-800">Progress Report</h2>
            <div class="flex justify-center">
                <canvas id="progress-chart" width="400" height="200" class="rounded-xl"></canvas>
            </div>
            <div class="text-center mt-4">
                <h3 class="text-xl font-semibold text-gray-700">Badges Earned:</h3>
                <div id="badge-display" class="badge-container justify-center">
                    <!-- Badges will be displayed here -->
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button id="next-level-btn" class="btn text-white rounded-lg px-8 py-3 font-semibold" style="display: none;">Continue to Next Level</button>
            </div>
        </div>

        <!-- Initial loading state -->
        <div id="loading-spinner" class="flex justify-center items-center p-10" style="display: none;">
            <div class="loader"></div>
        </div>
    </div>

    <!-- Message Box and Overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="message-box" id="message-box">
        <h3 id="message-title" class="text-2xl font-bold text-gray-800"></h3>
        <p id="message-text" class="text-gray-600"></p>
        <div id="message-badges" class="badge-container justify-center"></div>
        <button id="message-close-btn" class="btn rounded-lg px-6 py-2">OK</button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId;
        let userDocRef;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Quiz state variables
        let currentLevel = 0;
        let currentQuestionIndex = 0;
        let score = 0;
        let userBadges = [];
        let quizState = {};
        let quizIsLoaded = false;
        
        // Data structure for challenges and levels
        const challenges = [
            {
                level: 1,
                title: "Introduction to Personal Finance",
                questions: [
                    { question: "What is a budget?", options: ["A plan for saving money", "A list of things you want to buy", "An estimate of income and expenditure for a set period", "A document for tax filing"], answer: "An estimate of income and expenditure for a set period", badge: "💰" },
                    { question: "What does 'APY' stand for?", options: ["Annual Percentage Yield", "Annual Payment Year", "Asset Protection Yield", "Average Profitability Yield"], answer: "Annual Percentage Yield", badge: "📈" },
                    { question: "Which of the following is considered a 'want'?", options: ["Shelter", "Food", "Entertainment", "Healthcare"], answer: "Entertainment", badge: "🛍️" },
                    { question: "What is the purpose of an emergency fund?", options: ["To invest in the stock market", "To pay for a vacation", "To cover unexpected expenses", "To buy a new car"], answer: "To cover unexpected expenses", badge: "🛡️" },
                    { question: "What is the principle of 'compound interest'?", options: ["Earning interest on your initial investment only", "Earning interest on interest", "Paying a fixed rate of interest", "Lending money to friends"], answer: "Earning interest on interest", badge: "🌱" },
                    { question: "Which of these is a major component of a credit score?", options: ["Your social media activity", "Your payment history", "Your age", "Your salary"], answer: "Your payment history", badge: "💳" },
                    { question: "What is a stock?", options: ["A type of bond", "A loan to a company", "A unit of ownership in a company", "A government-issued security"], answer: "A unit of ownership in a company", badge: "🏢" },
                    { question: "What is the main goal of investing?", options: ["To buy expensive things", "To spend all your money", "To make your money grow over time", "To avoid paying taxes"], answer: "To make your money grow over time", badge: "💎" },
                    { question: "A high-interest credit card debt is a form of:", options: ["Good debt", "Bad debt", "Asset", "Equity"], answer: "Bad debt", badge: "📉" },
                    { question: "What is inflation?", options: ["A decrease in the price of goods and services", "A rise in the general level of prices", "An increase in the value of money", "A decline in the economy"], answer: "A rise in the general level of prices", badge: "🎈" }
                ]
            },
            {
                level: 2,
                title: "Investing Basics",
                questions: [
                    { question: "What is a diversified portfolio?", options: ["An investment in a single company", "A portfolio with only high-risk stocks", "A mix of different types of investments", "A portfolio managed by a single person"], answer: "A mix of different types of investments", badge: "🎲" },
                    { question: "What is a mutual fund?", options: ["An individual stock purchase", "A collective investment fund managed by a professional", "A type of insurance policy", "A government savings bond"], answer: "A collective investment fund managed by a professional", badge: "🤝" },
                    { question: "What is a stock vs. a bond?", options: ["A bond is ownership, a stock is a loan", "A stock is ownership, a bond is a loan", "They are the same thing", "Bonds are riskier than stocks"], answer: "A stock is ownership, a bond is a loan", badge: "⚖️" },
                    { question: "What does 'P/E ratio' stand for?", options: ["Price-to-Earnings Ratio", "Profit and Expense Ratio", "Portfolio Equity Ratio", "Performance and Earnings Ratio"], answer: "Price-to-Earnings Ratio", badge: "📊" },
                    { question: "What is a bear market?", options: ["A period when stock prices are rising", "A period when the economy is booming", "A period when stock prices are falling", "A market with no price changes"], answer: "A period when stock prices are falling", badge: "🐻" },
                    { question: "What is the purpose of a 401(k) plan?", options: ["To save for a down payment on a house", "To save for retirement", "To pay for college tuition", "To purchase a new car"], answer: "To save for retirement", badge: "👴" },
                    { question: "Which of these is generally considered the most liquid asset?", options: ["Real Estate", "Stocks", "Cash", "Fine Art"], answer: "Cash", badge: "💧" },
                    { question: "What is a dividend?", options: ["A fee for buying a stock", "A portion of a company's earnings paid to shareholders", "The initial price of a stock", "A type of loan from a company"], answer: "A portion of a company's earnings paid to shareholders", badge: "🎁" },
                    { question: "The S&P 500 tracks the performance of:", options: ["The 500 largest companies in the world", "The 500 largest publicly traded companies in the U.S.", "The 500 most expensive stocks", "The 500 oldest companies"], answer: "The 500 largest publicly traded companies in the U.S.", badge: "🗽" },
                    { question: "What is a 'bull market'?", options: ["A market when prices are falling", "A market when prices are rising", "A market with no price changes", "A market controlled by government"], answer: "A market when prices are rising", badge: "🐂" }
                ]
            },
            {
                level: 3,
                title: "Advanced Financial Concepts",
                questions: [
                    { question: "What is a capital gain?", options: ["A loss on an investment", "The profit from selling an asset", "Interest earned on a savings account", "A tax deduction"], answer: "The profit from selling an asset", badge: "📈" },
                    { question: "What is a 'Fiduciary'?", options: ["An insurance salesperson", "A financial advisor who must act in your best interest", "A bank teller", "A stock market analyst"], answer: "A financial advisor who must act in your best interest", badge: "🤝" },
                    { question: "What is the 'Rule of 72'?", options: ["A rule for calculating interest rates", "A shortcut to estimate the number of years required to double your money", "A rule for credit card payments", "A rule for calculating taxes"], answer: "A shortcut to estimate the number of years required to double your money", badge: "📏" },
                    { question: "What is a prospectus?", options: ["A type of stock certificate", "A legal document describing an investment opportunity", "A magazine about finance", "A type of loan"], answer: "A legal document describing an investment opportunity", badge: "📜" },
                    { question: "What is a mortgage?", options: ["A loan used to buy a car", "A loan to purchase real estate", "A loan for a vacation", "A personal loan"], answer: "A loan to purchase real estate", badge: "🏡" },
                    { question: "What is the function of a central bank?", options: ["To lend money to individuals", "To control a country's money supply", "To manage stock portfolios", "To offer credit cards"], answer: "To control a country's money supply", badge: "🏛️" },
                    { question: "What is 'asset allocation'?", options: ["The process of selling all your assets", "Distributing your investments among different asset classes", "The total value of your assets", "A fee charged by a bank"], answer: "Distributing your investments among different asset classes", badge: "💼" },
                    { question: "What is the difference between a Roth IRA and a Traditional IRA?", options: ["Roth is for short-term savings, Traditional is for long-term", "Roth is after-tax contributions, Traditional is pre-tax", "Roth has higher contribution limits", "Traditional is for younger people"], answer: "Roth is after-tax contributions, Traditional is pre-tax", badge: "🛡️" },
                    { question: "What is 'Net Worth'?", options: ["Your total income", "Your total assets minus your total liabilities", "The amount of money you have in savings", "Your annual salary"], answer: "Your total assets minus your total liabilities", badge: "⚖️" },
                    { question: "What is an annuity?", options: ["A type of bond", "A loan for a business", "A contract with an insurance company that provides regular payments", "A type of mutual fund"], answer: "A contract with an insurance company that provides regular payments", badge: "👵" }
                ]
            }
        ];

        // DOM elements
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreDisplay = document.getElementById('score-display');
        const levelDisplay = document.getElementById('level-display');
        const badgeDisplay = document.getElementById('badge-display');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const overlay = document.getElementById('overlay');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const messageCloseBtn = document.getElementById('message-close-btn');
        const messageBadges = document.getElementById('message-badges');
        const userIdDisplay = document.getElementById('user-id-display');
        
        let chartInstance = null;

        // Function to show custom message box
        function showMessage(title, text, badges = []) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageBadges.innerHTML = '';
            badges.forEach(badge => {
                const badgeEl = document.createElement('div');
                badgeEl.className = 'badge';
                badgeEl.innerHTML = `<span class="badge-text">${badge}</span>`;
                messageBadges.appendChild(badgeEl);
            });
            overlay.style.display = 'block';
            messageBox.style.display = 'flex';
        }

        // Function to hide custom message box
        function hideMessage() {
            overlay.style.display = 'none';
            messageBox.style.display = 'none';
        }

        // Initialize Firebase
        const initializeFirebase = async () => {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'progress', 'quiz');
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    
                    // Listen for real-time updates to the user's progress
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists() && quizIsLoaded) {
                            const data = docSnap.data();
                            quizState = data.quizState;
                            currentLevel = quizState.currentLevel;
                            currentQuestionIndex = quizState.currentQuestionIndex;
                            score = quizState.score;
                            userBadges = quizState.badges;
                            updateUI();
                        } else {
                            // If no data exists, start from scratch
                            startGame();
                        }
                    }, (error) => {
                        console.error("Error listening to progress updates:", error);
                    });
                } else {
                    console.log("User is signed out or anonymous.");
                    // Sign in anonymously if not authenticated
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        };

        // Function to save quiz state to Firestore
        const saveQuizState = async () => {
            if (userId) {
                const quizData = {
                    score: score,
                    currentLevel: currentLevel,
                    currentQuestionIndex: currentQuestionIndex,
                    badges: userBadges
                };
                
                try {
                    await setDoc(userDocRef, { quizState: quizData }, { merge: true });
                } catch (e) {
                    console.error("Error saving document: ", e);
                }
            }
        };

        // Add event listener to save progress before the user leaves the page
        window.addEventListener('beforeunload', saveQuizState);
        
        // Function to load the quiz state from Firestore on page load
        const loadQuizState = async () => {
            if (userId) {
                loadingSpinner.style.display = 'flex';
                quizSection.style.display = 'none';

                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data().quizState;
                        currentLevel = data.currentLevel;
                        currentQuestionIndex = data.currentQuestionIndex;
                        score = data.score;
                        userBadges = data.badges;
                        quizState = data;
                        showMessage("Welcome Back!", `You are on Level ${currentLevel} with a score of ${score}.`, userBadges);
                    } else {
                        // If no data exists, start from scratch
                        startGame();
                    }
                } catch (e) {
                    console.error("Error getting document:", e);
                    startGame();
                } finally {
                    quizIsLoaded = true;
                    loadingSpinner.style.display = 'none';
                    quizSection.style.display = 'flex';
                }
            } else {
                startGame();
            }
        };

        // Initialize a new game
        const startGame = () => {
            currentLevel = 1;
            currentQuestionIndex = 0;
            score = 0;
            userBadges = [];
            quizState = {
                score: 0,
                currentLevel: 1,
                currentQuestionIndex: 0,
                badges: []
            };
            
            // Initial save to Firestore
            saveQuizState();
            
            updateUI();
        };

        // Function to update the UI
        const updateUI = () => {
            if (currentLevel > challenges.length) {
                showResults();
                return;
            }

            const currentChallenge = challenges[currentLevel - 1];
            const currentQuestion = currentChallenge.questions[currentQuestionIndex];
            
            if (currentQuestion) {
                levelDisplay.textContent = `Level ${currentLevel}`;
                scoreDisplay.textContent = `Score: ${score}`;
                questionText.textContent = currentQuestion.question;
                optionsContainer.innerHTML = '';
                
                // Shuffle options
                const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
                
                shuffledOptions.forEach(option => {
                    const optionBtn = document.createElement('button');
                    optionBtn.textContent = option;
                    optionBtn.className = 'option-btn';
                    optionBtn.onclick = () => checkAnswer(option);
                    optionsContainer.appendChild(optionBtn);
                });
            } else {
                showResults();
            }
        };

        // Function to check the user's answer
        const checkAnswer = (selectedOption) => {
            const currentChallenge = challenges[currentLevel - 1];
            const currentQuestion = currentChallenge.questions[currentQuestionIndex];
            
            // Disable all option buttons
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
            
            if (selectedOption === currentQuestion.answer) {
                score += 10;
                
                // Add badge if it's a new one
                if (currentQuestion.badge && !userBadges.includes(currentQuestion.badge)) {
                    userBadges.push(currentQuestion.badge);
                }
                
                // Highlight correct option
                Array.from(optionsContainer.children).forEach(btn => {
                    if (btn.textContent === currentQuestion.answer) {
                        btn.classList.add('correct');
                    }
                });
                
                // Save state after correct answer
                quizState.score = score;
                quizState.badges = userBadges;
                saveQuizState();
                
                showMessage("Correct!", "Great job! You've earned a new badge!", userBadges);
                messageCloseBtn.onclick = () => {
                    hideMessage();
                    nextQuestion();
                };
            } else {
                // Highlight correct and incorrect options
                Array.from(optionsContainer.children).forEach(btn => {
                    if (btn.textContent === selectedOption) {
                        btn.classList.add('incorrect');
                    }
                    if (btn.textContent === currentQuestion.answer) {
                        btn.classList.add('correct');
                    }
                });
                showMessage("Incorrect!", `The correct answer was: ${currentQuestion.answer}.`, userBadges);
                messageCloseBtn.onclick = () => {
                    hideMessage();
                    nextQuestion();
                };
            }
        };

        // Function to proceed to the next question
        const nextQuestion = () => {
            currentQuestionIndex++;
            quizState.currentQuestionIndex = currentQuestionIndex;
            saveQuizState();
            updateUI();
        };

        // Function to show the final results and chart
        const showResults = () => {
            quizSection.style.display = 'none';
            resultsSection.style.display = 'flex';
            
            const totalQuestions = challenges[currentLevel - 1].questions.length;
            const correctAnswers = score / 10;
            const incorrectAnswers = totalQuestions - correctAnswers;
            
            // Display badges
            badgeDisplay.innerHTML = '';
            userBadges.forEach(badge => {
                const badgeEl = document.createElement('div');
                badgeEl.className = 'badge';
                badgeEl.innerHTML = `<span class="badge-text">${badge}</span>`;
                badgeDisplay.appendChild(badgeEl);
            });
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const ctx = document.getElementById('progress-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Correct', 'Incorrect'],
                    datasets: [{
                        data: [correctAnswers, incorrectAnswers],
                        backgroundColor: ['#10b981', '#ef4444'],
                        hoverBackgroundColor: ['#059669', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const label = tooltipItem.label || '';
                                    const value = tooltipItem.raw;
                                    const percentage = ((value / totalQuestions) * 100).toFixed(2);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            nextLevelBtn.style.display = currentLevel < challenges.length ? 'block' : 'none';
            nextLevelBtn.onclick = nextLevel;
        };
        
        // Function to move to the next level
        const nextLevel = () => {
            currentLevel++;
            currentQuestionIndex = 0;
            score = 0;
            
            // Update quiz state and save
            quizState.currentLevel = currentLevel;
            quizState.currentQuestionIndex = currentQuestionIndex;
            quizState.score = score;
            saveQuizState();

            resultsSection.style.display = 'none';
            quizSection.style.display = 'flex';
            updateUI();
        };
        
        // Function for the back button
        const goToPreviousPage = () => {
            saveQuizState(); // Ensure state is saved before leaving
            window.history.back();
        };
        
        messageCloseBtn.onclick = hideMessage;

        window.onload = function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            script.onload = () => {
                if (typeof __firebase_config !== 'undefined') {
                    initializeFirebase();
                } else {
                    console.log("Firebase config not available. Running in local mode.");
                    startGame();
                    loadingSpinner.style.display = 'none';
                    quizSection.style.display = 'flex';
                }
            };
            document.head.appendChild(script);
        };
    </script>
</body>
</html>

